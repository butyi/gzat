# gzat

Application template for Motorola/Freescale/NXP MC68HC908GZ60

## Terminology

### Monitor loader

Monitor loader is a PC side software which can update program memory of an
empty (virgin) microcontroller.
Disadvantages are it needs special hardware interface and it is slow.
My one is available
[here](https://github.com/butyi/gzml.py/) in Python language, or
[here](https://github.com/butyi/gzml.c/) in C language.
I propose the Python one.

### Bootloader

Bootloader is software embedded in the microcontroller, which can receive data
from a hardware interface and write it into its own program memory.
This software needs to be programmed into the microcontroller only once by a
monitor loader. 
My one is available 
[here](https://github.com/butyi/gzbl/).

### Downloader

Downloader is PC side software. The communication partner of Bootloader.
It can send the pre-compiled software (or any other data) to data to
microcontroller through the supported hardware interface.
My one is available
[here](https://github.com/butyi/gzdl.py/) in Python language, or
[here](https://github.com/butyi/gzdl.c/) in C language.
I propose the Python one.

### Application

Application is the real software for the main purpose. It is easier if you
start your application software from an application template.
Application template is a sample software which initializes and uses almost
all modules of microcontroller for some basic purpose. You can download into
uC and it already works and does something. You just need to modify it for your 
purpose. 
My one is available 
[here](https://github.com/butyi/gzat/).

## Services

Main file is `prg.asm`. This is the frame of software. Other files are just included by `prg.asm`.

### Analog Digital Converter

Continuously read the configured analog channels in 10bits format. Channel change is done automatic by interrupt routine. 
Up to date values are simply always available in the storage RAM array.

### Controller Area Network

CAN is initialized to accept messages with every CAN ID. Baud rate is 250k.
Both received and transmited messages are written into serial terminal if MESSAGE2SCI macro is defined.
Message with CAN ID 0x1CE0C0B0 is transmited periodically in every 1s.
If message with CAN ID 0x18FE110B is received, message with CAN ID 0x0CEE222F is transmited as a response.
Bus off recovery is implemented.

To save CPU resource, translate CAN ID between phisical and logical are done compiler.
Runtime software only works with phisical ID. This is the format how microcontroller stores the CAN id in registers.
Use macro LD_CAN_ID for transmission and CMP_CAN_ID for reception to compare received CAN ID like in example code.

### Debug LED handler

Toggles the debug LED on the configured port. The ready to use LED is useful during development or to show status of application.

### PWM

Pulse Width Modulation signal is generated by timer modules of microcontroller.
This code uses unbuffered mode on first timer and first channel.
Interrupt is used to update duty cycle in correct time point which ensures there will never be wrong pulse.
T1CH0_RAM variable shall be changed to change duty cycle.

### Serial Communication Interface

Initializes the UART RS232 with baud rate 57600, 8bits, no parity for debug and/or application purpose. 
The task implements download reset function and a simple echo.

### Timers decremented by Time Base Module

Module is used for application timers. Timer interrupt is invoked around every 32ms. This means value 30 in timer byte results 1s timing.
Timers are count down types, so tu pull up timers write the value into timer byte, what will be decreased till zero. You need to check its zero state.

### Task handler

This is a tiny task handler. LoSchedule function takes over the execution to next task. 
Every task have own stack with configured size.
At task handover the configured registers are saved and restored into task stack.

## Compile

Check out the repo and just call `asm8 prg.asm` on Linux. On Windows use `asm8.exe prg.asm`. Thanks to [ASPiSYS](http://www.aspisys.com/asm8.htm) for compiler!
prg.s19 will be ready to be downloaded by once GZ downloader [gzdl.c](https://github.com/butyi/gzdl.c/) or [gzdl.py](https://github.com/butyi/gzdl.py/).

## Bash files

- `./c`: Compile
- `./p`: Program and Terminal
- `./t`: Terminal only
- `./cp`: Compile, (if there is no compile error) Program and Terminal

On Windows PC, `*.bat` files must be created based on these bash files. Inside calls are very similar, but batch systax is different from bash systax.

## License

This is free. You can do anything you want with it.
While I am using Linux, I got so many support from free projects, I am happy if I can help for the community.

## Keywords

Motorola, Freescale, NXP, MC68HC908GZ60, 68HC908GZ60, HC908GZ60, MC908GZ60, 908GZ60, HC908GZ48, HC908GZ32, HC908GZ, 908GZ

###### 2019 Janos Bencsik

